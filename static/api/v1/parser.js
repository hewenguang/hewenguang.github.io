(()=>{"use strict";function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var t=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}var i,n,r;return i=t,(n=[{key:"start",value:function(e,t){var i=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=e.querySelectorAll("h1");if(1===r.length&&dom.position(r[0]).bottom<=n)return r[0];var o=[];return utils.each(e.querySelectorAll("h1, h2, h3"),(function(e){i.filterNode(e,n)||o.push(e)})),o.length>0||utils.each(e.querySelectorAll('[id*="title"], [class*="title"]'),(function(e){i.filterNode(e,n)||o.push(e)})),this.getNode(o,t)||t}},{key:"getNode",value:function(e,t){var i,n=this,r="";return utils.each(e,(function(e){var o=dom.nodeText(e);if(!(o.length>200)){var a=n.maxSubstr(t,o);a.length>=3&&a.length>r.length&&(r=a,i=e)}})),i}},{key:"filterNode",value:function(e,t){return!dom.visible(e)||e.getElementsByTagName("a").length>1||dom.position(e).top>t+500||void 0}},{key:"maxSubstr",value:function(e,t){if(!utils.isString(e)||!utils.isString(t)||e.length<0||t.length<0)return"";if(e.length>t.length){var i=e;e=t,t=i}for(var n=e.length,r=n;r>0;r--)for(var o=0;o<n-r;o++){var a=e.substr(o,r+1);if(t.indexOf(a)>=0)return a}return""}}])&&e(i.prototype,n),r&&e(i,r),t}();function i(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var n=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._PUNCTUATIONS=/：|。|；|，|,|\.|\?|、|”|“/,this._MAYBE_PARENT=/div|article|section|body/i,this._LIKE_ELEMENTS=/article|body|content|main|post/i,this._UNLIKE_ROLES=["menu","menubar","complementary","navigation","alert","alertdialog","dialog"],this._UNLIKE_ELEMENTS=/toast|loading|dialog|-ad-|ai2html|banner|breadcrumbs|combx|recommendation|community|cover-wrap|disqus|extra|footer|gdpr|legends|menu|related|remark|replies|rss|shoutbox|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote|adsbygoogle/i}var t,n,r;return t=e,(n=[{key:"start",value:function(e){this.preprocess(e.body);var t=this.getNodes(e.body);if(!utils.isArray(t))return this.deleteStyle(t),t;var i=this.weighted(t);return this._LIKE_ELEMENTS.test("".concat(i.tagName," ").concat(i.className," ").concat(i.id))&&utils.isNumber(i.score)&&(i.score+=10),utils.isNumber(i.score)&&i.score<30||dom.nodeText(i).length<100?void 0:(this.deleteStyle(i),i)}},{key:"deleteStyle",value:function(e){utils.isElement(e)&&utils.each(e.querySelectorAll("[style]"),(function(e){dom.removeAttr(e,"style")}))}},{key:"getNodes",value:function(e){var t=this,i=Array.prototype.slice.call(e.querySelectorAll("p, span, li, td, pre, img")),n=utils.filter(i,(function(e){return t.filterNode(e)}));if(!(n.length<=0))return n}},{key:"filterNode",value:function(e){if(dom.tag(e,"img"))return!0;if(!dom.visible(e))return!1;if(dom.tag(e,"li")&&e.getElementsByTagName("a").length>0)return!1;var t=dom.nodeText(e);return!(t.length<15&&!this._PUNCTUATIONS.test(t))}},{key:"weighted",value:function(e){var t=this,i={score:0};return utils.each(e,(function(e){var n=1;if(dom.tag(e,"img")){var r=e.naturalWidth,o=e.naturalHeight;r<=0&&o<=0&&(n+=2),r>400&&o>400&&(n+=(r+o)/800)}else{var a=dom.nodeText(e);n+=a.split(t._PUNCTUATIONS).length,n+=Math.min(Math.floor(a.length/100),3),n+=Math.min(e.getElementsByTagName("br").length/2,5),n*=1-dom.linkDensity(e)}!utils.isNumber(e.score)&&(e.score=0),e.score+=n,e.score>i.score&&(i=e);var s=dom.parents(e,3,(function(e){return t._MAYBE_PARENT.test(e.tagName)}));utils.each(s,(function(e,t){!utils.isNumber(e.score)&&(e.score=0),e.score+=n/(t<2?t+2:3*t),e.score>i.score&&(i=e)}))})),i}},{key:"_nextNode",value:function(e){for(var t=e;t&&1!=t.nodeType&&/^\s*$/.test(t.textContent);)t=t.nextSibling;return t}},{key:"preprocess",value:function(e){var t=this,i=e.querySelectorAll("br");i.length>4&&(dom.setStyle("display","none"),utils.each(i,(function(e){if(e.parentElement){for(var i=!1,n=e.nextSibling;(n=t._nextNode(n))&&dom.tag(n,"br");){i=!0;var r=n.nextSibling;dom.remove(n),n=r}if(i){var o=dom.create("p");for(e.parentNode.replaceChild(o,e),n=o.nextSibling;n&&!(dom.tag(n,"br")&&t._nextNode(n.nextSibling)&&dom.tag(n,"br"));){var a=n.nextSibling;if(n.wholeText&&utils.isString(n.wholeText)){var s=n.wholeText.replace(/&nbsp;/gi,"").trim();s.length>0&&(o.innerText=s),dom.remove(n)}else o.appendChild(n);n=a}}}})),dom.removeAttr(e,"style"));var n=window.innerWidth;utils.each(e.querySelectorAll("aside, section, div, ins, link, style, svg"),(function(e){if(t._UNLIKE_ROLES.includes(dom.getAttr(e,"role")))dom.remove(e);else{var i="".concat(e.className," ").concat(e.id);if(!t._LIKE_ELEMENTS.test(i)){if(t._UNLIKE_ELEMENTS.test(i))return void dom.remove(e);if(/sidebar/i.test(i)&&dom.position(e).width<=n/2)return void dom.remove(e);if(/comment/i.test(i))return void dom.remove(e)}/link|style|svg/i.test(e.tagName)&&dom.remove(e)}})),this.deleteStyle(e),utils.each(e.getElementsByTagName("img"),(function(e){dom.setStyle(e,"height","0px")}))}}])&&i(t.prototype,n),r&&i(t,r),e}();function r(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var o=new t,a=new n,s=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._retry=0,this._ready=!0,this._first=!0}var t,i,n;return t=e,(i=[{key:"getContext",value:function(){if(this.container&&this.container.contentDocument)return this.container.contentDocument;this.container=this.container||dom.create("iframe",{sandbox:"allow-scripts allow-same-origin allow-popups",style:{top:0,left:0,zIndex:-1,opacity:0,width:"100%",height:"100%",overflow:"hidden",position:"fixed",pointerEvents:"none"}});var e=this.container.parentElement;return e?e.parentElement||(dom.remove(this.container),document.body.appendChild(this.container)):document.body.appendChild(this.container),this.container.contentDocument}},{key:"start",value:function(e){var t=this;this._ready=!1,this._first=!utils.isString(e),this.getContext(),this._first?this._check():(this.container.addEventListener("load",(function e(){t.container.removeEventListener("load",e),t._check()})),this.container.src=e)}},{key:"_check",value:function(){var e=this,t=this.getContext();if(!t)return app.doAction("loading",!1),app.doAction("parser-fail","invalid context"),void(this._retry=0);if(this._first){var i=document.documentElement.innerHTML;t.documentElement.innerHTML=i.replace(/<script.*?>(.|\n)*?<\/script>|<iframe.*?>.*?<\/iframe>/gi,"")}utils.isUndefined(t)||utils.isUndefined(t.title)||!utils.isString(t.title)||t.title.length<=0||utils.isUndefined(t.body)?this._retry<5&&setTimeout((function(){e._retry++,e._check()}),500):this._exactor(t)}},{key:"_exactor",value:function(e){var t=this,i=a.start(e);if(utils.isElement(i)){if(!/div|article|section|body/i.test(i.tagName)&&this._retry<1)return this._retry++,dom.setStyle(i,"display","none"),void this._exactor(e);this._retry=0,this._url=e.URL.startsWith("http")?e.URL:location.href;var n=dom.position(i),r=o.start(e,e.title,n.top);if(!utils.isElement(r))return this._article=i,this._title=e.title,app.doAction("parser-success",this._first),void(this._ready=!0);for(var s=i;!this.validate(r,s)&&!dom.tag(s,"body");)s=s.parentElement;this._article=s,this._title=r,app.doAction("parser-success",this._first),this._ready=!0}else setTimeout((function(){t._retry<5?(t._retry++,t._check()):(app.doAction("loading",!1),app.doAction("parser-fail","invalid paragraph"),t._retry=0)}),500)}},{key:"validate",value:function(e,t){if(!utils.isElement(t))return!0;if(t.contains(e))return!0;var i=dom.position(e),n=dom.position(t);return Math.abs(n.top-i.bottom)<360||void 0}}])&&r(t.prototype,i),n&&r(t,n),e}());function l(){api.send("cc-disable"),s.start()}app._cache.parser=s,app.addAction("url-change",(function(){setTimeout(l,0)})),app.addAction("browserAction-click",(function(){app.loadPlugin("render")})),app.addAction("parser-success",(function(){api.send("cc-enable"),location.search.indexOf("reading-easier")>=0?app.loadPlugin("render"):api.send("option",{execute:"get",name:"parser"},(function(e){var t=e.error,i=e.data;t?app.addAction("error",t):utils.isBoolean(i)&&i&&app.loadPlugin("render")}))})),l()})();